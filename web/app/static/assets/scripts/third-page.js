function brushed(){var e=brush.extent()[0];d3.event.sourceEvent&&(e=y.invert(d3.mouse(this)[1]),brush.extent([e,e]),updateGraph(e)),sliderHandle.attr("cy",y(e)),sliderLabel.attr("y",y(e)).text(e.toFixed(6)),currentLinkVisibleBound=e}var backgroundColor="#404a59",areaColor="#323c48",borderColor="#111",emphasisAreaColor="#2a333d",foregroundColor="#fff",shadowColor="#333",margin={top:0,bottom:0,right:0,left:0},width=$("#net").width(),height=$(window).height(),color=d3.scale.category20(),linkColor="#999",strokeColor="#fff",arrowColor="#ddd",highlightColor="cyan",textColor="#fff",strokeWidth="1.5px",linkVisibleLowerBound=.3,linkVisibleUpperBound=30,force=d3.layout.force().charge(-180).linkDistance(width/6).size([width,height]),svg=d3.select($("#net").get(0)).append("svg").attr("width",width).attr("height",height).attr("y","10");svg.append("text").attr("x",0).attr("y",height/10).attr("text-anchor","start").style("font-size",Math.max(width/32,8)+"pt").style("fill","#fff").text("互动与联系"),svg.append("text").attr("x",0).attr("y",height/6).attr("text-anchor","start").style("font-size",Math.max(width/54,8)+"pt").style("fill","#fff").text("城际间微博提及频率"),svg.append("text").attr("class","mentionLabel").attr("x",0).attr("y",height/10*9).attr("text-anchor","start").style("font-size",Math.max(width/72,8)+"pt").style("fill",textColor).text("");var updateMentionLabel=function(e,t){var i="";if(-1===e&&-1===t)i="";else if(-1===t)i=net.cityList[e]+" 提及 ：";else if(-1===e)i=" 提及 "+net.cityList[t]+" ：";else{var r=net.cities[e].links[t];i=net.cityList[e]+" 提及 "+net.cityList[t]+"："+Number(r).toFixed(7)}d3.select("svg").select(".mentionLabel").text(i)},markerHeight=8,markerWidthRatio=8,markerWidth=markerHeight*markerWidthRatio;svg.append("defs").selectAll("arrorMarker").data(["-fixed","-auto","-fixed-highlighted","-auto-highlighted"]).enter().append("marker").attr("id",function(e){return"arrow"+e}).attr("viewBox","0 "+markerHeight/-2+" "+markerWidth+" "+markerHeight).attr("refX",markerWidth).attr("refY",-.2).attr("markerWidth",markerWidth).attr("markerHeight",markerHeight).attr("orient","auto").attr("markerUnits",function(e){return e.search("-fixed")>-1?"userSpaceOnUse":""}).style("fill",function(e){return e.search("-highlighted")>-1?highlightColor:arrowColor}).append("path").attr("d","M0,"+markerHeight/-2+"L0,"+markerHeight/2+"L"+markerWidth+",0");var chosenNodes=[null,null],chosenLink=null,chosenNodesCount=function(){var e=0;return null!==chosenNodes[0]&&(e+=1),null!==chosenNodes[1]&&(e+=1),e},highlightNode=function(e){if(chosenNodes.indexOf(e)<0){var t=!1;chosenNodes[0]?chosenNodes[1]||(chosenNodes[1]=e,t=!0):(chosenNodes[0]=e,t=!0),t&&(d3.select(e).select("circle").style("stroke",highlightColor).style("stroke-width","5px"),highlightLink())}},normalizeNode=function(e){chosenNodes[chosenNodes.indexOf(e)]=null,d3.select(e).select("circle").style("stroke",strokeColor).style("stroke-width",strokeWidth),highlightLink()},highlightLink=function(){var e=d3.select(chosenNodes[0]).data()[0],t=d3.select(chosenNodes[1]).data()[0],i=e?e.id:-1,r=t?t.id:-1;if(chosenLink&&chosenLink.attr("marker-end",function(e){return"url(#arrow"+(e.value>1.8?"-fixed":"-auto")+")"}).style("stroke",strokeColor),2===chosenNodesCount()&&net.cities[i].links[r]>=currentLinkVisibleBound)for(var n=svg.selectAll(".link").data(),l=0;l<n.length;l+=1)if(n[l].source.id===i&&n[l].target.id===r){chosenLink=d3.select(svg.selectAll(".link")[0][l]),chosenLink.attr("marker-end",function(e){return"url(#arrow"+(e.value>1.8?"-fixed-highlighted":"-auto-highlighted")+")"}).style("stroke",highlightColor);break}updateMentionLabel(i,r)},updateLinks=function(e,t){for(var i=net.cities,r=[],n=0;n<i.length;n+=1)for(var l=i[n],a=0;a<net.cityList.length&&a!=n;a+=1){var o=l.links[a];if(o>t){var s={};s.source=n,s.target=a,s.value=Math.min(o*(linkVisibleLowerBound/t),linkVisibleUpperBound),r.push(s)}}return e.nodes=i,e.links=r,e},maxLinkVisibleBound=.0032,currentLinkVisibleBound=maxLinkVisibleBound,updateGraph=function(e){var t=updateLinks({},e);console.log("Links: "+t.links.length),force.links(t.links).start(),t.links.length>200?force.linkDistance(width/6*(t.links.length/180)):force.linkDistance(width/6),svg.selectAll(".link").remove();svg.selectAll(".link").data(t.links).enter().append("path").attr("class","link").attr("marker-end",function(e){return"url(#arrow"+(e.value>1.8?"-fixed":"-auto")+")"}).style("fill","none").style("stroke",strokeColor).style("stroke-opacity",".8").style("stroke-width",function(e){return e.value});force.tick(),highlightLink()},net={};d3.json("/static/assets/data/net.json",function(e,t){if(e)throw e;net=t;var i=updateLinks({},maxLinkVisibleBound);force.charge(-120).nodes(i.nodes).links(i.links).start();var r=(svg.selectAll(".link").data(i.links).enter().append("path").attr("class","link").attr("marker-end",function(e){return"url(#arrow"+(e.value>1.8?"-fixed":"-auto")+")"}).style("fill","none").style("stroke",strokeColor).style("stroke-opacity",".8").style("stroke-width",function(e){return e.value}),svg.selectAll(".node").data(i.nodes).enter().append("g").attr("class","node"));r.append("circle").attr("class","nodeCircle").attr("r",function(e){return e.value}).style("stroke",strokeColor).style("stroke-width",strokeWidth).style("fill",function(e){return color(e.id)}).style("transition","all 0.1s ease-in").call(force.drag),r.append("title").text(function(e){return e.name+"\n自提及率："+Number(e.links[e.id]).toFixed(6)+"\n平均提及率: "+Number(e.mentionRate).toFixed(6)+"\n平均每"+e.perMention+"篇微博中被提及一次"}),r.append("text").attr("class","nodeName").text(function(e){return e.name}).style("font-size",function(e){return Math.max(e.value,8)+"pt"}).style("transition","all 0.1s ease-in").attr("x",function(e){return e.value+2}).attr("y",function(e){return"0.31em"}).style("fill",textColor);r.on("mouseover",function(e){d3.select(this).select("text").style("font-size",function(e){return 1.2*Math.max(e.value,8)+"pt"}),d3.select(this).select("circle").attr("r",function(e){return 1.2*e.value})}).on("mouseleave",function(e){d3.select(this).select("text").style("font-size",function(e){return Math.max(e.value,8)+"pt"}),d3.select(this).select("circle").attr("r",function(e){return e.value})}).on("dblclick",function(e){var t=this,i=chosenNodes.indexOf(t),r=chosenNodesCount();0===r?highlightNode(t):1===r?i>-1?normalizeNode(t):highlightNode(t):2===r&&i>-1&&normalizeNode(t)}),force.on("tick",onTick)});var ticking=1,onTick=function(e){ticking&&(svg.selectAll(".link").attr("d",linkArc),svg.selectAll(".node").select("circle").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),svg.selectAll(".node").select("text").attr("dx",function(e){return e.x}).attr("dy",function(e){return e.y})),ticking=1-ticking},linkLine=function(e){var t=e.target.x-e.source.x,i=e.target.y-e.source.y;Math.sqrt(t*t+i*i);return"M"+e.source.x+","+e.source.y+"L"+e.target.x+","+e.target.y},linkArc=function(e){var t=e.target.x-e.source.x,i=e.target.y-e.source.y,r=t*t+i*i;return"M"+e.source.x+","+e.source.y+"A"+r+","+r+" 0 0,1 "+e.target.x+","+e.target.y};context.init(),context.attach(".nodeCircle",[{text:"提及情况统计",action:function(e){var t=context.selection().parentNode,i=d3.select(t).data()[0];updatePie(i.id,1),$("#trigger").click()}},{text:"被提及情况统计",action:function(e){var t=context.selection().parentNode,i=d3.select(t).data()[0];updatePie(i.id,0),$("#trigger").click()}}]);var minimumPieValue=1,mainLabelSize=width/120,myPie=new d3pie("#modal",{header:{title:{text:"微博提及情况统计",color:textColor,fontSize:Math.max(3*mainLabelSize,12)},subtitle:{text:"城市：频率 比例",color:textColor,fontSize:Math.max(2*mainLabelSize,8)}},size:{canvasWidth:.6*width,canvasHeight:.8*height,pieOuterRadius:"90%"},data:{sortOrder:"value-desc",smallSegmentGrouping:{enabled:!0,label:"其他城市",value:minimumPieValue},content:[{label:"城市1",value:1,color:color(1)},{label:"城市2",value:2,color:color(2)}]},labels:{outer:{hideWhenLessThanPercentage:minimumPieValue+.1,pieDistance:6},inner:{hideWhenLessThanPercentage:minimumPieValue},mainLabel:{color:textColor,fontSize:mainLabelSize},percentage:{color:textColor,decimalPlaces:0},value:{color:"#adadad",fontSize:11},lines:{enabled:!0},truncation:{enabled:!0}},effects:{load:{effect:"none"}}});$("#trigger").leanModal({overlay:.8});var updatePie=function(e,t){var i=net.cityList[e],r=[],n=0;if(0===t)for(var l=net.cities[e].totalMentioned,a=0;a<net.cities.length;a+=1)n=Number(net.cities[a].links[e]),r.push({id:a,name:net.cityList[a],label:net.cityList[a]+" "+n.toFixed(6),value:n,percentage:(n/l*100).toFixed(2)+"%",color:color(a)});else for(var o=net.cities[e].links[net.cityList.length],s=net.cities[e].links,d=0;d<net.cityList.length;d+=1)n=Number(s[d])+1e-30,r.push({id:d,name:net.cityList[d],label:net.cityList[d]+" "+n.toFixed(6),value:n,percentage:(n/o*100).toFixed(2)+"%",color:color(d)});myPie.updateProp("header.title.text",i+(t?"微博的提及":"被提及")+"情况统计"),myPie.updateProp("data.content",r),myPie.updateProp("callbacks.onClickSegment",onClickPieSegment)},onClickPieSegment=function(e){var t=e.data,i=t.id,r=t.name;console.log(r),console.log(i),i>=0&&r&&myPie.updateProp("header.subtitle.text",r+": "+t.value.toFixed(6)+" "+t.percentage)},sliderWidth=width/100,sliderHeight=.8*height,sliderMargin={top:(height-sliderHeight)/2,right:sliderWidth+Math.max(5*sliderWidth,36)},y=d3.scale.linear().domain([.0032,1e-5]).range([0,sliderHeight]).clamp(!0),sliderAxis=d3.svg.axis().scale(y).orient("left").ticks(20).tickFormat(function(e){return e}).tickSize(0).tickPadding(sliderWidth);svg.append("g").attr("class","y axis").attr("transform","translate( "+(width-sliderMargin.right)+","+sliderMargin.top+")").call(sliderAxis).style("font",Math.max(sliderWidth,8)+"px sans-serif").style("fill",textColor).select(".domain").style("fill","none").style("stroke","#fff").style("stroke-opacity","0.6").style("stroke-width",sliderWidth/2).style("stroke-linecap","round").select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","halo").style("fill","none").style("stroke","#ddd").style("stroke-width",sliderWidth).style("stroke-linecap","round");var brush=d3.svg.brush().y(y).extent([0,0]).on("brush",brushed).clamp(!0),slider=svg.append("g").attr("class","slider").attr("transform","translate("+(width-sliderMargin.right)+","+sliderMargin.top+")").call(brush),sliderHandle=slider.append("circle").attr("class","handle").attr("r",.8*sliderWidth).style("fill","#fff").style("stroke","#000").style("stroke-opacity","0.5").style("stroke-width","1.25px").style("cursor","pointer"),sliderLabel=slider.append("text").text("0.003000").attr("class","sliderLabel").attr("x",sliderWidth).attr("y",sliderWidth/3).attr("text-anchor","start").style("fill",textColor).style("font",Math.max(sliderWidth,8)+"px sans-serif").style("fill",textColor);
